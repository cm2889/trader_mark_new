{% extends 'base.html' %}

{% block title%}User{% endblock %}

{% block header_actions %}
  <!-- Filter (match previous design: white button) -->
  <button
    type="button"
    data-modal-target="crud-modal"
    data-modal-toggle="crud-modal"
    class="inline-flex cursor-pointer items-center gap-2 h-11 px-3 rounded-md ring-1 ring-[var(--border-color)] bg-[var(--white-color)]">
      <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 15 15" fill="none">
        <path d="M9.14689 14.5H5.85278C5.68963 14.4979 5.53377 14.4321 5.41839 14.3167C5.30302 14.2014 5.23726 14.0455 5.23513 13.8824V7.5L0.829247 1.48C0.759611 1.38947 0.717206 1.28097 0.706997 1.16721C0.696787 1.05345 0.719196 0.939133 0.7716 0.837647C0.824099 0.736453 0.90324 0.651519 1.00048 0.592014C1.09772 0.532509 1.20937 0.500693 1.32337 0.5H13.6763C13.7903 0.500693 13.902 0.532509 13.9992 0.592014C14.0964 0.651519 14.1756 0.736453 14.2281 0.837647C14.2805 0.939133 14.3029 1.05345 14.2927 1.16721C14.2825 1.28097 14.2401 1.38947 14.1704 1.48L9.76454 7.5V13.8824C9.76241 14.0455 9.69665 14.2014 9.58128 14.3167C9.46591 14.4321 9.31004 14.4979 9.14689 14.5ZM6.47042 13.2647H8.52925V7.29412C8.5286 7.16289 8.5721 7.03527 8.65278 6.93177L12.441 1.73529H2.55866L6.36337 6.93177C6.44404 7.03527 6.48755 7.16289 6.4869 7.29412L6.47042 13.2647Z"
              fill="#6B7280"/>
      </svg>
      <span class="hidden md:block">Filter</span>
  </button>

  <!-- Add New User -->
  <a href="{% url 'backend:user_add' %}"
     class="inline-flex items-center gap-2 h-11 px-3 rounded-md bg-[var(--primary-color)] text-[var(--button-text-color)]">
    <span class="grid h-5 w-5 place-items-center rounded-full bg-[var(--bg-color)]/20">
      <svg width="20" height="20" viewBox="0 0 24 24">
        <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </span>
    <span class="hidden md:block">Add New User</span>
  </a>
{% endblock %}

{% block modals %}
<div class="flex relative items-center justify-between">
  <div class="mt-4 flex items-center justify-end gap-3">

    <!-- Filter Modal -->
    <div id="crud-modal" tabindex="-1" aria-hidden="true"
         class="hidden overflow-y-auto overflow-x-hidden fixed inset-0 z-50 flex items-center justify-center xl:-top-[15%] xl:right-[20%]">
      <div class="relative p-4 w-full max-w-md max-h-full">

        <!-- dialog (match previous: white bg) -->
        <div class="mx-auto w-[92%] sm:w-[100%] xl:w-[760px] relative top-16 rounded-xl bg-[var(--white-color)]
                    ring-1 ring-[var(--border-color)] shadow-xl">
          <form method="get" id="filterForm">

            <!-- header -->
            <div class="flex items-center justify-between px-5 pt-5">
              <h3 id="filterTitle" class="text-lg text-[var(--primary-color)] font-semibold">Filter</h3>
              <button type="button"
                      class="bg-transparent hover:bg-[var(--bg-color)] rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center"
                      data-modal-toggle="crud-modal">
                <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                  <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
                </svg>
                <span class="sr-only">Close modal</span>
              </button>
            </div>

            <!-- body (same fields/logic, design only) -->
            <div class="px-5 pb-5 pt-2 grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="text-sm mb-1 block">Users</label>
                <select name="username" class="select2-items w-full" data-placeholder="All Users" style="width:100%">
                  <option></option>
                  {% for fuser in filter_user %}
                    <option value="{{ fuser.username }}"
                      {% if request.GET.username and fuser.username == request.GET.username %} selected {% endif %}>
                      {{ fuser.get_name }} ({{ fuser.username }})
                    </option>
                  {% endfor %}
                </select>
              </div>

              <div>
                <label class="text-sm mb-1 block">Status</label>
                <select name="is_active" class="select2-items w-full" data-placeholder="Active" style="width:100%">
                  <option></option>
                  <option value="1" {% if request.GET.is_active == '1' %}selected{% endif %}>Active</option>
                  <option value="0" {% if request.GET.is_active == '0' %}selected{% endif %}>Inactive</option>
                </select>
              </div>

              <div>
                <label class="text-sm mb-1 block">Date</label>
                <div class="relative">
                  <input type="date" name="created_from" value="{{ request.GET.created_from }}"
                         class="h-11 w-full rounded-md text-[var(--text-color)] bg-[var(--white-color)] pl-3 pr-3 text-sm
                                ring-1 ring-[var(--border-color)] focus:outline-none" />
                </div>
              </div>

              <div class="md:mt-[22px]">
                <div class="relative">
                  <input type="date" name="created_to" value="{{ request.GET.created_to }}"
                         class="h-11 w-full rounded-md text-[var(--text-color)] bg-[var(--white-color)] pl-3 pr-3 text-sm
                                ring-1 ring-[var(--border-color)] focus:outline-none" />
                </div>
              </div>
            </div>

            <!-- footer buttons -->
            <div class="px-5 pb-5 flex items-center justify-end gap-2">
              <a href="{% url 'backend:user_list' %}"
                 class="h-10 px-4 py-2 rounded-md ring-1 ring-[var(--border-color)] bg-[var(--white-color)]">Reset</a>

              <button type="submit"
                      class="h-10 px-5 rounded-md bg-[var(--primary-color)] text-[var(--button-text-color)]
                             inline-flex items-center gap-2">
                <span>Filter</span>
              </button>
            </div>

          </form>
        </div>

      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block content %}
<section class="text-[var(--text-color)] min-h-screen overflow-x-hidden px-1">

  <!-- Date range banner (match previous: white bg) -->
  {% comment %} <div class="mt-4 rounded-md ring-1 ring-[var(--border-color)] bg-[var(--white-color)] px-4 py-3 text-sm font-bold">
    {% if request.GET.created_from or request.GET.created_to %}
      {{ request.GET.created_from|default:"Start" }} – {{ request.GET.created_to|default:"End" }}
    {% else %}
    {% endif %}
  </div> {% endcomment %}

  <!-- Table card (match previous: white bg + header var + no extra rounding) -->
  <div class="relative mt-2 ring-1 ring-[var(--border-color)] bg-[var(--white-color)]">
    <div class="overflow-x-auto overscroll-x-contain" style="overflow-y: visible;">
      <table class="w-full min-w-[1000px] text-sm">
        <colgroup>
          <col class="w-[100px]">
          <col class="w-[180px]">
          <col class="w-[260px]">
          <col class="w-[160px]">
          <col class="w-[120px]">
          <col class="w-[100px]">
        </colgroup>

        <thead class="bg-[var(--table-header)] border-b border-[var(--border-color)]">
          <tr class="text-left">
            <th class="px-4 py-3 font-bold whitespace-nowrap">Profile</th>
            <th class="px-4 py-3 font-bold whitespace-nowrap">
              <span class="inline-flex items-center gap-1">Username</span>
            </th>
            <th class="px-4 py-3 font-bold whitespace-nowrap">Email</th>
            <th class="px-4 py-3 font-bold whitespace-nowrap">
              <span class="inline-flex items-center gap-1">Date Created</span>
            </th>
            <th class="px-4 py-3 font-bold whitespace-nowrap">Status</th>
            <th class="px-4 py-3 font-bold text-right pr-2 whitespace-nowrap">Action</th>
          </tr>
        </thead>

        <tbody class="divide-y divide-[var(--border-color)]">
          {% for data in user_list %}
          <tr class="hover:bg-[var(--bg-color)]/50 transition-colors">
            <td class="px-4 py-3">
              <div class="inline-flex items-center gap-2">
                <img src="{{ data.get_profile_photo_url }}" class="h-9 w-9 rounded-full ring-1 ring-[var(--border-color)]" alt="">
                <span class="font-medium">{{ data.first_name|default:"" }}</span>
              </div>
            </td>

            <td class="px-4 py-3 whitespace-nowrap font-medium">{{ data.username|default:"" }}</td>

            <td class="px-4 py-3">
              <span class="block truncate">{{ data.email|default:"" }}</span>
            </td>

            <td class="px-4 py-3 whitespace-nowrap">{{ data.date_joined|date:"d-M-Y" }}</td>

            <td class="px-4 py-3 whitespace-nowrap">
              {% if data.is_active %}
                <span class="inline-flex h-6 items-center rounded-full px-2 text-xs bg-green-100 text-green-800">Active</span>
              {% else %}
                <span class="inline-flex h-6 items-center rounded-full px-2 text-xs bg-red-100 text-red-800">Inactive</span>
              {% endif %}
            </td>

            <!-- Action dropdown (match previous: white dropdown + divider) -->
            <td class="px-4 py-3 text-right">
              <div class="inline-block" data-menu-wrap>
                <button type="button"
                        class="h-8 w-8 rounded-md cursor-pointer hover:bg-[var(--bg-color)]"
                        data-menu-btn aria-haspopup="true" aria-expanded="false"
                        onclick="
                          const menu=this.nextElementSibling;
                          const willOpen=menu.classList.contains('hidden');
                          document.querySelectorAll('[data-menu]').forEach(m=>m.classList.add('hidden'));
                          document.querySelectorAll('[data-menu-btn]').forEach(b=>b.setAttribute('aria-expanded','false'));
                          if(willOpen){menu.classList.remove('hidden'); this.setAttribute('aria-expanded','true');}
                        ">
                  ⋯
                </button>

                <div class="hidden absolute right-4 mt-1 w-44 z-50 rounded-md bg-[var(--white-color)]
                            ring-1 ring-[var(--border-color)] shadow-lg" data-menu role="menu">
                  <a href="{% url 'backend:user_permission' data.id %}"
                     class="block px-3 py-2 text-sm text-left flex items-center gap-2 justify-start"
                     role="menuitem"
                     onclick="this.closest('[data-menu]').classList.add('hidden'); this.closest('[data-menu-wrap]').querySelector('[data-menu-btn]').setAttribute('aria-expanded','false');">
                    User Permission
                  </a>

                  <div class="border-t border-[var(--border-color)]"></div>

                  <a href="{% url 'backend:reset_password' data.id %}"
                     class="block px-3 py-2 text-sm text-left flex items-center gap-2 justify-start"
                     role="menuitem"
                     onclick="this.closest('[data-menu]').classList.add('hidden'); this.closest('[data-menu-wrap]').querySelector('[data-menu-btn]').setAttribute('aria-expanded','false');">
                    Reset Password
                  </a>
                </div>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="8" class="px-4 py-6 text-center text-[var(--text-light-color)]">No Data found.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- pagination (keep same logic; match previous styles) -->
    <div class="w-full py-4 border-t border-[var(--border-color)]">
      <div class="flex items-center justify-center">
        <div class="flex items-center gap-3">

          <nav class="flex items-center gap-1 text-sm" aria-label="Pagination">
            {% if page_obj.has_previous %}
              <a class="h-8 w-8 grid place-items-center rounded-full ring-1 ring-[var(--border-color)]"
                 href="?page=1{% if params %}&{{ params }}{% endif %}">««</a>
              <a class="h-8 w-8 grid place-items-center rounded-full ring-1 ring-[var(--border-color)]"
                 href="?page={{ page_obj.previous_page_number }}{% if params %}&{{ params }}{% endif %}">«</a>
            {% else %}
              <span class="h-8 w-8 grid place-items-center rounded-full opacity-40 select-none">««</span>
              <span class="h-8 w-8 grid place-items-center rounded-full opacity-40 select-none">«</span>
            {% endif %}

            {% for i in paginator_list %}
              {% if page_obj.number == i %}
                <span class="h-8 w-8 grid place-items-center rounded-full bg-[var(--bg-color)] text-[var(--primary-color)] font-medium">{{ i }}</span>
              {% else %}
                <a class="h-8 w-8 grid place-items-center rounded-full hover:bg-[var(--bg-color)]"
                   href="?page={{ i }}{% if params %}&{{ params }}{% endif %}">{{ i }}</a>
              {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
              <a class="h-8 w-8 grid place-items-center rounded-full hover:bg-[var(--bg-color)] text-[var(--primary-color)]"
                 href="?page={{ page_obj.next_page_number }}{% if params %}&{{ params }}{% endif %}">»</a>
              <a class="h-8 w-8 grid place-items-center rounded-full hover:bg-[var(--bg-color)] text-[var(--primary-color)]"
                 href="?page={{ last_page_number }}{% if params %}&{{ params }}{% endif %}">»»</a>
            {% else %}
              <span class="h-8 w-8 grid place-items-center rounded-full opacity-40 select-none">»</span>
              <span class="h-8 w-8 grid place-items-center rounded-full opacity-40 select-none">»»</span>
            {% endif %}
          </nav>

          <!-- page size (keep same logic; match previous style) -->
          <div class="ml-2">
            <div class="relative">
              <select
                class="h-9 pr-8 pl-3 rounded-md ring-1 ring-[var(--border-color)] bg-[var(--white-color)] text-sm appearance-none"
                onchange="location.href='?page=1{% if params %}&{{ params }}{% endif %}&page_size='+this.value">
                <option value="10" {% if request.GET.page_size == '10' or not request.GET.page_size %}selected{% endif %}>10</option>
                <option value="20" {% if request.GET.page_size == '20' %}selected{% endif %}>20</option>
                <option value="30" {% if request.GET.page_size == '30' %}selected{% endif %}>30</option>
                <option value="50" {% if request.GET.page_size == '50' %}selected{% endif %}>50</option>
              </select>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <div class="lg:hidden mt-4 h-2 w-2/3 mx-auto rounded-full bg-[var(--bg-color)]"></div>

</section>
{% endblock %}

{% block extra_js %}
<script>
  $(document).ready(function () {
    $('.select2-items').select2();
  });

  // close on outside click
  document.addEventListener('click', (e) => {
    if (!e.target.closest('[data-menu-wrap]')) {
      document.querySelectorAll('[data-menu]').forEach(m => m.classList.add('hidden'));
      document.querySelectorAll('[data-menu-btn]').forEach(b => b.setAttribute('aria-expanded','false'));
    }
  });

  // close on Esc
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      document.querySelectorAll('[data-menu]').forEach(m => m.classList.add('hidden'));
      document.querySelectorAll('[data-menu-btn]').forEach(b => b.setAttribute('aria-expanded','false'));
    }
  });
</script>
{% endblock %}
