{% extends 'base.html' %}
{% load static %}
{% block title %}Employee - Create{% endblock %}
{% block breadcrumb %}
    <span class="mx-1">›</span>
    <a href="{% url 'employee:list' %}" class="hover:underline">Employee</a>
    <span class="mx-1">›</span>
    <span>Add</span>
{% endblock %}
{% block content %}
    <style>
    @keyframes slide-in {
        from {
            opacity: 0;
            transform: translateX(400px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }
    .animate-slide-in {
        animation: slide-in 0.3s ease-out;
        transition: all 0.3s ease-out;
    }
    </style>
    <div class="min-h-screen bg-[var(--bg-color)] py-8 px-4 sm:px-6 lg:px-8">
        <div class="">
            <!-- Header -->
            <div class="mb-6">
                <h1 class="text-2xl font-semibold text-[var(--text-color)]">Create Employee</h1>
                <p class="text-sm text-[var(--text-light-color)] mt-1">
                    Fill in the employee information below. Only basic info is required.
                </p>
            </div>
            {% if from_lead_conversion %}
                <div class="mb-6 bg-emerald-50 border border-emerald-200 rounded-lg p-4">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-emerald-600"
                                 fill="currentColor"
                                 viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-emerald-800">Converting Lead to Employee</h3>
                            <p class="text-sm text-emerald-700 mt-1">
                                Basic information has been pre-filled from visitor data for
                                <strong>{{ visitor.first_name }} {{ visitor.last_name }}</strong>.
                                Please review and complete the remaining required fields.
                            </p>
                            {% if lead %}
                                <a href="{% url 'lead:detail' lead.pk %}"
                                   class="text-xs text-emerald-600 hover:text-emerald-800 underline mt-2 inline-block">
                                    View Original Lead
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endif %}
            <form method="post" enctype="multipart/form-data" class="space-y-4">
                {% csrf_token %}
                {% if from_lead_conversion %}
                    <input type="hidden" name="visitor_id" value="{{ visitor.id }}">
                    {% if lead %}<input type="hidden" name="lead_id" value="{{ lead.id }}">{% endif %}
                {% endif %}
                <!-- Basic Information Section -->
                <div class="bg-white rounded-lg shadow-sm border border-[var(--border-color)]">
                    <button type="button"
                            onclick="toggleSection('basic-info')"
                            class="w-full px-6 py-4 flex items-center justify-between text-left hover:bg-gray-50 transition-colors rounded-t-lg">
                        <span class="text-base font-medium text-[var(--text-color)]">Basic Information</span>
                        <svg id="basic-info-icon"
                             class="w-5 h-5 text-gray-500 transform rotate-180 transition-transform"
                             fill="none"
                             stroke="currentColor"
                             viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div id="basic-info"
                         class="px-6 pb-6 border-t border-[var(--border-color)]">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 pt-4">
                            <!-- First Name -->
                            <div>
                                <label class="block text-sm font-medium text-[var(--text-color)] mb-1">
                                    First Name <span class="text-red-500">*</span>
                                </label>
                                <input type="text"
                                       id="employee-first_name"
                                       name="employee-first_name"
                                       value="{{ employee_form.first_name.value|default:'' }}"
                                       placeholder="Enter First Name"
                                       class="w-full h-11 px-3 text-sm bg-white border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent outline-none">
                                {% if employee_form.first_name.errors %}
                                    <p class="text-red-500 text-xs mt-1">{{ employee_form.first_name.errors.0 }}</p>
                                {% endif %}
                            </div>
                            <!-- Last Name -->
                            <div>
                                <label class="block text-sm font-medium text-[var(--text-color)] mb-1">
                                    Last Name <span class="text-red-500">*</span>
                                </label>
                                <input type="text"
                                       id="employee-last_name"
                                       name="employee-last_name"
                                       value="{{ employee_form.last_name.value|default:'' }}"
                                       placeholder="Enter Last Name"
                                       class="w-full h-11 px-3 text-sm bg-white border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent outline-none">
                                {% if employee_form.last_name.errors %}
                                    <p class="text-red-500 text-xs mt-1">{{ employee_form.last_name.errors.0 }}</p>
                                {% endif %}
                            </div>
                            <!-- Phone Number-->
                            <div>
                                <label class="block text-sm font-medium text-[var(--text-color)] mb-1">
                                    Phone Number <span class="text-red-500">*</span>
                                </label>
                                <input type="text"
                                       id="employee-phone_number"
                                       name="employee-phone_number"
                                       value="{{ employee_form.phone_number.value|default:'' }}"
                                       placeholder="Enter Phone Number"
                                       class="w-full h-11 px-3 text-sm bg-white border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent outline-none">
                                {% if employee_form.phone_number.errors %}
                                    <p class="text-red-500 text-xs mt-1">{{ employee_form.phone_number.errors.0 }}</p>
                                {% endif %}
                            </div>
                            <!--Email -->
                            <div>
                                <label class="block text-sm font-medium text-[var(--text-color)] mb-1">
                                    Email <span class="text-red-500">*</span>
                                </label>
                                <input type="email"
                                       id="employee-email"
                                       name="employee-email"
                                       value="{{ employee_form.email.value|default:'' }}"
                                       placeholder="Enter Email"
                                       class="w-full h-11 px-3 text-sm bg-white border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent outline-none">
                                {% if employee_form.email.errors %}
                                    <p class="text-red-500 text-xs mt-1">{{ employee_form.email.errors.0 }}</p>
                                {% endif %}
                            </div>
                            <!-- QID No -->
                            <div>
                                <label class="block text-sm font-medium text-[var(--text-color)] mb-1">
                                    QID No <span class="text-red-500">*</span>
                                </label>
                                <input type="text"
                                       name="employee-qid_no"
                                       value="{{ employee_form.qid_no.value|default:'' }}"
                                       placeholder="Enter QID No"
                                       class="w-full h-11 px-3 text-sm bg-white border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent outline-none">
                                {% if employee_form.qid_no.errors %}
                                    <p class="text-red-500 text-xs mt-1">{{ employee_form.qid_no.errors.0 }}</p>
                                {% endif %}
                            </div>
                            <!-- Nationality -->
                            <div>
                                <label class="block text-sm font-medium text-[var(--text-color)] mb-1">Nationality</label>
                                <select name="employee-nationality"
                                        class="select2-items w-full h-11 px-3 pr-10 text-sm bg-white border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent outline-none">
                                    <option value="">Select Nationality</option>
                                    {% for nationality in nationalities %}
                                        <option value="{{ nationality.pk }}"
                                                {% if employee_form.nationality.value == nationality.pk|stringformat:"s" %}selected{% endif %}>
                                            {{ nationality.name }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <!-- Gender -->
                            <div>
                                <label class="block text-sm font-medium text-[var(--text-color)] mb-1">
                                    Gender <span class="text-red-500">*</span>
                                </label>
                                <select name="employee-gender"
                                        class="w-full h-11 px-3 pr-10 text-sm bg-white border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent outline-none">
                                    <option value="">Select Gender</option>
                                    <option value="M"
                                            {% if employee_form.gender.value == 'M' %}selected{% endif %}>Male</option>
                                    <option value="F"
                                            {% if employee_form.gender.value == 'F' %}selected{% endif %}>
                                        Female
                                    </option>
                                </select>
                                {% if employee_form.gender.errors %}
                                    <p class="text-red-500 text-xs mt-1">{{ employee_form.gender.errors.0 }}</p>
                                {% endif %}
                            </div <!-- Remarks -->
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-[var(--text-color)] mb-1">Remarks</label>
                                <textarea name="employee-remarks"
                                          rows="3"
                                          placeholder="Enter remarks..."
                                          class="w-full px-3 py-2 text-sm bg-white border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent outline-none resize-none">{{ employee_form.remarks.value|default:'' }}</textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Employment Details Section -->
                <div class="bg-white rounded-lg shadow-sm border border-[var(--border-color)]">
                    <button type="button"
                            onclick="toggleSection('employment-info')"
                            class="w-full px-6 py-4 flex items-center justify-between text-left hover:bg-gray-50 transition-colors rounded-t-lg">
                        <div class="flex items-center gap-3">
                            <span class="text-base font-medium text-[var(--text-color)]">Employment Details</span>
                            <span type="button"
                                  onclick="addEmploymentForm(event)"
                                  class="px-3 py-1 text-xs font-medium text-white bg-[var(--primary-color)] rounded hover:opacity-90 transition-opacity cursor-pointer">
                                <i class="fas fa-plus mr-1"></i>Add Employment
                            </span>
                        </div>
                        <svg id="employment-info-icon"
                             class="w-5 h-5 text-gray-500 transform transition-transform"
                             fill="none"
                             stroke="currentColor"
                             viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div id="employment-info"
                         class="px-6 pb-6 border-t border-[var(--border-color)] hidden">
                        <input type="hidden"
                               name="employment-TOTAL_FORMS"
                               id="employment-total-forms"
                               value="1">
                        <div id="employment-forms-container" class="pt-4">
                            <!-- Employment forms will be added here -->
                            <div class="employment-form-item border border-[var(--border-color)] rounded-lg p-4 mb-4"
                                 data-index="0">
                                <div class="flex justify-between items-center mb-4">
                                    <h4 class="text-sm font-semibold text-[var(--text-color)]">Employment #1</h4>
                                    <button type="button"
                                            onclick="removeEmploymentForm(this)"
                                            class="text-red-500 hover:text-red-700 remove-employment-btn"
                                            style="display: none">
                                        <i class="fas fa-trash"></i> Remove
                                    </button>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                                    <!-- Employment Joining Date -->
                                    <div>
                                        <label class="block text-sm font-medium text-[var(--text-color)] mb-1">Employment Joining Date</label>
                                        <input type="date"
                                               name="employment-0-joining_date"
                                               value=""
                                               class="flatpickr-date w-full h-11 px-3 text-sm bg-white border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent outline-none">
                                    </div>
                                    <!-- Work Status -->
                                    <div>
                                        <label class="block text-sm font-medium text-[var(--text-color)] mb-1">Work Status</label>
                                        <select name="employment-0-work_status"
                                                class="w-full h-11 px-3 pr-10 text-sm bg-white border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent outline-none">
                                            <option value="">Select Work Status</option>
                                            <option value="ACTIVE">Active</option>
                                            <option value="INACTIVE">Inactive</option>
                                            <option value="ON_LEAVE">On Leave</option>
                                            <option value="TERMINATED">Terminated</option>
                                        </select>
                                    </div>
                                    <!-- RP Expiry Date -->
                                    <div>
                                        <label class="block text-sm font-medium text-[var(--text-color)] mb-1">RP Expiry Date</label>
                                        <input type="date"
                                               name="employment-0-rp_expiry_date"
                                               value=""
                                               class="flatpickr-date w-full h-11 px-3 text-sm bg-white border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent outline-none">
                                    </div>
                                    <!-- Work Permit No -->
                                    <div>
                                        <label class="block text-sm font-medium text-[var(--text-color)] mb-1">Work Permit No</label>
                                        <input type="text"
                                               name="employment-0-work_permit_no"
                                               value=""
                                               placeholder="Enter Work Permit No"
                                               class="w-full h-11 px-3 text-sm bg-white border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent outline-none">
                                    </div>
                                    <!-- Work ID -->
                                    <div>
                                        <label class="block text-sm font-medium text-[var(--text-color)] mb-1">Work ID</label>
                                        <input type="text"
                                               name="employment-0-work_id"
                                               value=""
                                               placeholder="Enter Work ID"
                                               class="w-full h-11 px-3 text-sm bg-white border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent outline-none">
                                    </div>
                                    <!-- QID Renew Status -->
                                    <div>
                                        <label class="block text-sm font-medium text-[var(--text-color)] mb-1">QID Renew Status</label>
                                        <select name="employment-0-qid_renew_status"
                                                class="w-full h-11 px-3 pr-10 text-sm bg-white border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent outline-none">
                                            <option value="">Select Status</option>
                                            <option value="NOT_DUE">Not Due</option>
                                            <option value="PENDING">Pending</option>
                                            <option value="RENEWED">Renewed</option>
                                        </select>
                                    </div>
                                    <!-- QID Lost Status -->
                                    <div>
                                        <label class="block text-sm font-medium text-[var(--text-color)] mb-1">QID Lost Status</label>
                                        <select name="employment-0-qid_lost_status"
                                                class="w-full h-11 px-3 pr-10 text-sm bg-white border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent outline-none">
                                            <option value="">Select Status</option>
                                            <option value="YES">Yes</option>
                                            <option value="NO">No</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Contact Details Section -->
                <div class="bg-white rounded-lg shadow-sm border border-[var(--border-color)]">
                    <button type="button"
                            onclick="toggleSection('contact-info')"
                            class="w-full px-6 py-4 flex items-center justify-between text-left hover:bg-gray-50 transition-colors rounded-t-lg">
                        <span class="text-base font-medium text-[var(--text-color)]">Contact Details</span>
                        <svg id="contact-info-icon"
                             class="w-5 h-5 text-gray-500 transform transition-transform"
                             fill="none"
                             stroke="currentColor"
                             viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div id="contact-info"
                         class="px-6 pb-6 border-t border-[var(--border-color)] hidden">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 pt-4">
                            <!-- Phone No -->
                            <div>
                                <label class="block text-sm font-medium text-[var(--text-color)] mb-1">Phone No</label>
                                <input type="text"
                                       name="contact-phone_no"
                                       value="{{ contact_form.phone_no.value|default:'' }}"
                                       placeholder="Enter Phone No"
                                       class="w-full h-11 px-3 text-sm bg-white border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent outline-none">
                            </div>
                            <!-- Phone No Alt -->
                            <div>
                                <label class="block text-sm font-medium text-[var(--text-color)] mb-1">Phone No (Alt)</label>
                                <input type="text"
                                       name="contact-phone_no_alt"
                                       value="{{ contact_form.phone_no_alt.value|default:'' }}"
                                       placeholder="Enter Alternate Phone No"
                                       class="w-full h-11 px-3 text-sm bg-white border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent outline-none">
                            </div>
                            <!-- Roommate Phone -->
                            <div>
                                <label class="block text-sm font-medium text-[var(--text-color)] mb-1">Roommate Phone</label>
                                <input type="text"
                                       name="contact-roommate_phone"
                                       value="{{ contact_form.roommate_phone.value|default:'' }}"
                                       placeholder="Enter Roommate Phone"
                                       class="w-full h-11 px-3 text-sm bg-white border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent outline-none">
                            </div>
                            <!-- Relative Qatar Phone -->
                            <div>
                                <label class="block text-sm font-medium text-[var(--text-color)] mb-1">Relative Qatar Phone</label>
                                <input type="text"
                                       name="contact-relative_qatar_phone"
                                       value="{{ contact_form.relative_qatar_phone.value|default:'' }}"
                                       placeholder="Enter Relative Qatar Phone"
                                       class="w-full h-11 px-3 text-sm bg-white border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent outline-none">
                            </div>
                            <!-- Home Phone -->
                            <div>
                                <label class="block text-sm font-medium text-[var(--text-color)] mb-1">Home Phone</label>
                                <input type="text"
                                       name="contact-home_phone"
                                       value="{{ contact_form.home_phone.value|default:'' }}"
                                       placeholder="Enter Home Phone"
                                       class="w-full h-11 px-3 text-sm bg-white border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent outline-none">
                            </div>
                            <!-- Home Phone Alt -->
                            <div>
                                <label class="block text-sm font-medium text-[var(--text-color)] mb-1">Home Phone (Alt)</label>
                                <input type="text"
                                       name="contact-home_phone_alt"
                                       value="{{ contact_form.home_phone_alt.value|default:'' }}"
                                       placeholder="Enter Alternate Home Phone"
                                       class="w-full h-11 px-3 text-sm bg-white border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent outline-none">
                            </div>
                            <!-- Home Email -->
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-[var(--text-color)] mb-1">Home Email</label>
                                <input type="email"
                                       name="contact-home_email"
                                       value="{{ contact_form.home_email.value|default:'' }}"
                                       placeholder="Enter Home Email"
                                       class="w-full h-11 px-3 text-sm bg-white border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent outline-none">
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Address Section -->
                <div class="bg-white rounded-lg shadow-sm border border-[var(--border-color)]">
                    <button type="button"
                            onclick="toggleSection('address-info')"
                            class="w-full px-6 py-4 flex items-center justify-between text-left hover:bg-gray-50 transition-colors rounded-t-lg">
                        <span class="text-base font-medium text-[var(--text-color)]">Address</span>
                        <svg id="address-info-icon"
                             class="w-5 h-5 text-gray-500 transform transition-transform"
                             fill="none"
                             stroke="currentColor"
                             viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div id="address-info"
                         class="px-6 pb-6 border-t border-[var(--border-color)] hidden">
                        <div>
                            <div>
                                <label class="block text-sm font-medium text-[var(--text-color)] mb-1">
                                    Present
                                    Address
                                </label>
                                <textarea name="address-present_address"
                                          rows="3"
                                          placeholder="Enter Present Address"
                                          class="w-full px-3 py-2 text-sm bg-white border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent outline-none resize-none">{{ address_form.present_address.value|default:'' }}</textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-[var(--text-color)] mb-1">
                                    Permanent
                                    Address
                                </label>
                                <textarea name="address-permanent_address"
                                          rows="3"
                                          placeholder="Enter Permanent Address"
                                          class="w-full px-3 py-2 text-sm bg-white border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent outline-none resize-none">{{ address_form.permanent_address.value|default:'' }}</textarea>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 pt-4">
                            <!-- National Address -->
                            <div>
                                <label class="block text-sm font-medium text-[var(--text-color)] mb-1">National Address</label>
                                <textarea name="address-national_address"
                                          rows="3"
                                          placeholder="Enter National Address"
                                          class="w-full px-3 py-2 text-sm bg-white border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent outline-none resize-none">{{ address_form.national_address.value|default:'' }}</textarea>
                            </div>
                            <!-- Room Address -->
                            <div>
                                <label class="block text-sm font-medium text-[var(--text-color)] mb-1">Room Address</label>
                                <textarea name="address-room_address"
                                          rows="3"
                                          placeholder="Enter Room Address"
                                          class="w-full px-3 py-2 text-sm bg-white border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent outline-none resize-none">{{ address_form.room_address.value|default:'' }}</textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Passport Section -->
                <div class="bg-white rounded-lg shadow-sm border border-[var(--border-color)]">
                    <button type="button"
                            onclick="toggleSection('passport-info')"
                            class="w-full px-6 py-4 flex items-center justify-between text-left hover:bg-gray-50 transition-colors rounded-t-lg">
                        <div class="flex items-center gap-3">
                            <span class="text-base font-medium text-[var(--text-color)]">Passport</span>
                            <span type="button"
                                  onclick="addPassportForm(event)"
                                  class="px-3 py-1 text-xs font-medium text-white bg-[var(--primary-color)] rounded hover:opacity-90 transition-opacity cursor-pointer">
                                <i class="fas fa-plus mr-1"></i>Add Passport
                            </span>
                        </div>
                        <svg id="passport-info-icon"
                             class="w-5 h-5 text-gray-500 transform transition-transform"
                             fill="none"
                             stroke="currentColor"
                             viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div id="passport-info"
                         class="px-6 pb-6 border-t border-[var(--border-color)] hidden">
                        <div id="passport-forms-container" class="pt-4">
                            <!-- Passport forms will be added here -->
                            <div class="passport-form-item border border-[var(--border-color)] rounded-lg p-4 mb-4"
                                 data-index="0">
                                <div class="flex justify-between items-center mb-4">
                                    <h4 class="text-sm font-semibold text-[var(--text-color)]">Passport #1</h4>
                                    <button type="button"
                                            onclick="removePassportForm(this)"
                                            class="text-red-500 hover:text-red-700 remove-passport-btn"
                                            style="display: none">
                                        <i class="fas fa-trash"></i> Remove
                                    </button>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                                    <!-- Passport No -->
                                    <div>
                                        <label class="block text-sm font-medium text-[var(--text-color)] mb-1">Passport No</label>
                                        <input type="text"
                                               name="passport-0-passport_no"
                                               value=""
                                               placeholder="Enter Passport No"
                                               class="w-full h-11 px-3 text-sm bg-white border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent outline-none">
                                    </div>
                                    <!-- Passport Expiry Date -->
                                    <div>
                                        <label class="block text-sm font-medium text-[var(--text-color)] mb-1">Passport Expiry Date</label>
                                        <input type="date"
                                               name="passport-0-passport_expiry_date"
                                               value=""
                                               class="flatpickr-date w-full h-11 px-3 text-sm bg-white border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent outline-none">
                                    </div>
                                    <!-- Passport Renewed -->
                                    <div>
                                        <label class="block text-sm font-medium text-[var(--text-color)] mb-1">Passport Renewed</label>
                                        <div class="flex items-center h-11">
                                            <input type="checkbox"
                                                   name="passport-0-passport_renewed"
                                                   class="w-5 h-5 text-[var(--primary-color)] border-[var(--border-color)] rounded focus:ring-[var(--primary-color)]">
                                            <span class="ml-2 text-sm text-[var(--text-color)]">Yes</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Driving License Section -->
                <div class="bg-white rounded-lg shadow-sm border border-[var(--border-color)]">
                    <button type="button"
                            onclick="toggleSection('driving-license-info')"
                            class="w-full px-6 py-4 flex items-center justify-between text-left hover:bg-gray-50 transition-colors rounded-t-lg">
                        <div class="flex items-center gap-3">
                            <span class="text-base font-medium text-[var(--text-color)]">Driving License</span>
                            <span type="button"
                                  onclick="addDrivingLicenseForm(event)"
                                  class="px-3 py-1 text-xs font-medium text-white bg-[var(--primary-color)] rounded hover:opacity-90 transition-opacity cursor-pointer">
                                <i class="fas fa-plus mr-1"></i>Add License
                            </span>
                        </div>
                        <svg id="driving-license-info-icon"
                             class="w-5 h-5 text-gray-500 transform transition-transform"
                             fill="none"
                             stroke="currentColor"
                             viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div id="driving-license-info"
                         class="px-6 pb-6 border-t border-[var(--border-color)] hidden">
                        <div id="license-forms-container" class="pt-4">
                            <!-- License forms will be added here -->
                            <div class="license-form-item border border-[var(--border-color)] rounded-lg p-4 mb-4"
                                 data-index="0">
                                <div class="flex justify-between items-center mb-4">
                                    <h4 class="text-sm font-semibold text-[var(--text-color)]">License #1</h4>
                                    <button type="button"
                                            onclick="removeDrivingLicenseForm(this)"
                                            class="text-red-500 hover:text-red-700 remove-license-btn"
                                            style="display: none">
                                        <i class="fas fa-trash"></i> Remove
                                    </button>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                                    <!-- License No -->
                                    <div>
                                        <label class="block text-sm font-medium text-[var(--text-color)] mb-1">License No</label>
                                        <input type="text"
                                               name="driving_license-0-license_no"
                                               value=""
                                               placeholder="Enter License No"
                                               class="w-full h-11 px-3 text-sm bg-white border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent outline-none">
                                    </div>
                                    <!-- License Expiry Date -->
                                    <div>
                                        <label class="block text-sm font-medium text-[var(--text-color)] mb-1">License Expiry Date</label>
                                        <input type="date"
                                               name="driving_license-0-license_expiry_date"
                                               value=""
                                               class="flatpickr-date w-full h-11 px-3 text-sm bg-white border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent outline-none">
                                    </div>
                                    <!-- License Renewed -->
                                    <div>
                                        <label class="block text-sm font-medium text-[var(--text-color)] mb-1">License Renewed</label>
                                        <div class="flex items-center h-11">
                                            <input type="checkbox"
                                                   name="driving_license-0-license_renewed"
                                                   class="w-5 h-5 text-[var(--primary-color)] border-[var(--border-color)] rounded focus:ring-[var(--primary-color)]">
                                            <span class="ml-2 text-sm text-[var(--text-color)]">Yes</span>
                                        </div>
                                    </div>
                                    <!-- License Renew Status -->
                                    <div>
                                        <label class="block text-sm font-medium text-[var(--text-color)] mb-1">License Renew Status</label>
                                        <select name="driving_license-0-license_renew_status"
                                                class="w-full h-11 px-3 pr-10 text-sm bg-white border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent outline-none">
                                            <option value="">Select Status</option>
                                            <option value="YES">Renewed</option>
                                            <option value="NO">Not Renewed</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Health Insurance Section -->
                <div class="bg-white rounded-lg shadow-sm border border-[var(--border-color)]">
                    <button type="button"
                            onclick="toggleSection('health-insurance-info')"
                            class="w-full px-6 py-4 flex items-center justify-between text-left hover:bg-gray-50 transition-colors rounded-t-lg">
                        <span class="text-base font-medium text-[var(--text-color)]">Health & Insurance</span>
                        <svg id="health-insurance-info-icon"
                             class="w-5 h-5 text-gray-500 transform transition-transform"
                             fill="none"
                             stroke="currentColor"
                             viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div id="health-insurance-info"
                         class="px-6 pb-6 border-t border-[var(--border-color)] hidden">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 pt-4">
                            <!-- Hamad Health Card -->
                            <div>
                                <label class="block text-sm font-medium text-[var(--text-color)] mb-1">Hamad Health Card</label>
                                <div class="flex items-center h-11">
                                    <input type="checkbox"
                                           name="health_insurance-hamad_health_card"
                                           {% if health_insurance_form.hamad_health_card.value %}checked{% endif %}
                                           class="w-5 h-5 text-[var(--primary-color)] border-[var(--border-color)] rounded focus:ring-[var(--primary-color)]">
                                    <span class="ml-2 text-sm text-[var(--text-color)]">Yes</span>
                                </div>
                            </div>
                            <!-- WM Insurance -->
                            <div>
                                <label class="block text-sm font-medium text-[var(--text-color)] mb-1">WM Insurance</label>
                                <select name="health_insurance-wm_insurance"
                                        class="w-full h-11 px-3 pr-10 text-sm bg-white border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent outline-none">
                                    <option value="">Select</option>
                                    <option value="YES"
                                            {% if health_insurance_form.wm_insurance.value == 'YES' %}selected{% endif %}>
                                        Yes
                                    </option>
                                    <option value="NO"
                                            {% if health_insurance_form.wm_insurance.value == 'NO' %}selected{% endif %}>
                                        No
                                    </option>
                                </select>
                            </div>
                            <!-- Family Health Card -->
                            <div>
                                <label class="block text-sm font-medium text-[var(--text-color)] mb-1">Family Health Card</label>
                                <select name="health_insurance-family_health_card"
                                        class="w-full h-11 px-3 pr-10 text-sm bg-white border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent outline-none">
                                    <option value="">Select</option>
                                    <option value="YES"
                                            {% if health_insurance_form.family_health_card.value == 'YES' %}selected{% endif %}>
                                        Yes
                                    </option>
                                    <option value="NO"
                                            {% if health_insurance_form.family_health_card.value == 'NO' %}selected{% endif %}>
                                        No
                                    </option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Form Actions -->
                <div class="flex flex-col sm:flex-row gap-4 pt-6 border-t border-gray-100">
                    <button type="submit"
                            class="w-full sm:w-auto px-6 py-2.5 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition">
                        Create Employee
                    </button>
                    <a href="{% url 'employee:list' %}"
                       class="w-full sm:w-auto px-6 py-2.5 bg-gray-100 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-200 transition text-center">
                        Cancel
                    </a>
                </div>
            </form>
        </div>
    </div>
{% endblock %}
{% block extra_js %}
    <script>
    // Toggle section visibility
    function toggleSection(sectionId) {
        const section = document.getElementById(sectionId);
        const icon = document.getElementById(sectionId + '-icon');
        
        if (section.classList.contains('hidden')) {
            section.classList.remove('hidden');
            icon.classList.add('rotate-180');
        } else {
            section.classList.add('hidden');
            icon.classList.remove('rotate-180');
        }
    }

    // Initialize flatpickr for date fields
    document.addEventListener('DOMContentLoaded', function() {
        flatpickr('.flatpickr-date', {
            dateFormat: 'Y-m-d',
            allowInput: true
        });

        // Initialize Select2
        $('.select2-items').select2({
            placeholder: 'Select an option',
            allowClear: true
        });

        // Update remove button visibility
        updateEmploymentRemoveButtons();
    });

    let employmentFormCount = 1;

    function addEmploymentForm(event) {
        event.stopPropagation();
        event.preventDefault();
        
        const container = document.getElementById('employment-forms-container');
        const newIndex = employmentFormCount;
        
        const formHtml = `
            <div class="employment-form-item border border-[var(--border-color)] rounded-lg p-4 mb-4" data-index="${newIndex}">
                <div class="flex justify-between items-center mb-4">
                    <h4 class="text-sm font-semibold text-[var(--text-color)]">Employment #${newIndex + 1}</h4>
                    <button type="button" onclick="removeEmploymentForm(this)" class="text-red-500 hover:text-red-700 remove-employment-btn">
                        <i class="fas fa-trash"></i> Remove
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    <!-- Employment Joining Date -->
                    <div>
                        <label class="block text-sm font-medium text-[var(--text-color)] mb-1">Employment Joining Date</label>
                        <input type="date" name="employment-${newIndex}-joining_date" value="" class="flatpickr-date w-full h-11 px-3 text-sm bg-white border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent outline-none">
                    </div>

                    <!-- Work Status -->
                    <div>
                        <label class="block text-sm font-medium text-[var(--text-color)] mb-1">Work Status</label>
                        <select name="employment-${newIndex}-work_status" class="w-full h-11 px-3 pr-10 text-sm bg-white border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent outline-none">
                            <option value="">Select Work Status</option>
                            <option value="ACTIVE">Active</option>
                            <option value="INACTIVE">Inactive</option>
                            <option value="ON_LEAVE">On Leave</option>
                            <option value="TERMINATED">Terminated</option>
                        </select>
                    </div>

                    <!-- RP Expiry Date -->
                    <div>
                        <label class="block text-sm font-medium text-[var(--text-color)] mb-1">RP Expiry Date</label>
                        <input type="date" name="employment-${newIndex}-rp_expiry_date" value="" class="flatpickr-date w-full h-11 px-3 text-sm bg-white border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent outline-none">
                    </div>

                    <!-- Work Permit No -->
                    <div>
                        <label class="block text-sm font-medium text-[var(--text-color)] mb-1">Work Permit No</label>
                        <input type="text" name="employment-${newIndex}-work_permit_no" value="" placeholder="Enter Work Permit No" class="w-full h-11 px-3 text-sm bg-white border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent outline-none">
                    </div>

                    <!-- Work ID -->
                    <div>
                        <label class="block text-sm font-medium text-[var(--text-color)] mb-1">Work ID</label>
                        <input type="text" name="employment-${newIndex}-work_id" value="" placeholder="Enter Work ID" class="w-full h-11 px-3 text-sm bg-white border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent outline-none">
                    </div>

                    <!-- QID Renew Status -->
                    <div>
                        <label class="block text-sm font-medium text-[var(--text-color)] mb-1">QID Renew Status</label>
                        <select name="employment-${newIndex}-qid_renew_status" class="w-full h-11 px-3 pr-10 text-sm bg-white border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent outline-none">
                            <option value="">Select Status</option>
                            <option value="NOT_DUE">Not Due</option>
                            <option value="PENDING">Pending</option>
                            <option value="RENEWED">Renewed</option>
                        </select>
                    </div>

                    <!-- QID Lost Status -->
                    <div>
                        <label class="block text-sm font-medium text-[var(--text-color)] mb-1">QID Lost Status</label>
                        <select name="employment-${newIndex}-qid_lost_status" class="w-full h-11 px-3 pr-10 text-sm bg-white border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent outline-none">
                            <option value="">Select Status</option>
                            <option value="YES">Yes</option>
                            <option value="NO">No</option>
                        </select>
                    </div>
                </div>
            </div>
        `;
        
        container.insertAdjacentHTML('beforeend', formHtml);
        employmentFormCount++;
        
        // Update total forms counter
        document.getElementById('employment-total-forms').value = employmentFormCount;
        
        // Reinitialize flatpickr for new date fields
        flatpickr('.flatpickr-date', {
            dateFormat: 'Y-m-d',
            allowInput: true
        });

        // Update remove button visibility
        updateEmploymentRemoveButtons();
    }

    function removeEmploymentForm(button) {
        const formItem = button.closest('.employment-form-item');
        formItem.remove();
        
        // Update numbering and reindex
        reindexEmploymentForms();
        
        // Update remove button visibility
        updateEmploymentRemoveButtons();
    }

    function reindexEmploymentForms() {
        const formItems = document.querySelectorAll('.employment-form-item');
        formItems.forEach((item, index) => {
            // Update title
            const title = item.querySelector('h4');
            title.textContent = `Employment #${index + 1}`;
            
            // Update data-index
            item.setAttribute('data-index', index);
            
            // Update all input/select names
            const inputs = item.querySelectorAll('input, select');
            inputs.forEach(input => {
                const name = input.getAttribute('name');
                if (name && name.startsWith('employment-')) {
                    const newName = name.replace(/employment-\d+-/, `employment-${index}-`);
                    input.setAttribute('name', newName);
                }
            });
        });
        
        // Update total forms counter and employmentFormCount
        employmentFormCount = formItems.length;
        document.getElementById('employment-total-forms').value = employmentFormCount;
    }

    function updateEmploymentRemoveButtons() {
        const formItems = document.querySelectorAll('.employment-form-item');
        formItems.forEach((item) => {
            const removeBtn = item.querySelector('.remove-employment-btn');
            if (removeBtn) {
                if (formItems.length > 1) {
                    removeBtn.style.display = 'inline-flex';
                } else {
                    removeBtn.style.display = 'none';
                }
            }
        });
    }

    // Auto-fill from Visitor Data - AJAX
    let visitorCheckTimeout;
    let lastCheckedEmail = '';
    let lastCheckedPhone = '';
    
    function showVisitorNotification(message, type = 'info') {
        // Remove existing notification if any
        const existingNotification = document.getElementById('visitor-notification');
        if (existingNotification) {
            existingNotification.remove();
        }
        
        // Create notification element
        const notification = document.createElement('div');
        notification.id = 'visitor-notification';
        notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg flex items-center gap-3 animate-slide-in`;
        
        if (type === 'success') {
            notification.className += ' bg-green-500 text-white';
            notification.innerHTML = `<i class="fas fa-check-circle"></i><span>${message}</span>`;
        } else if (type === 'info') {
            notification.className += ' bg-blue-500 text-white';
            notification.innerHTML = `<i class="fas fa-info-circle"></i><span>${message}</span>`;
        }
        
        document.body.appendChild(notification);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            notification.style.opacity = '0';
            notification.style.transform = 'translateX(400px)';
            setTimeout(() => notification.remove(), 300);
        }, 5000);
    }
    
    function highlightField(fieldId) {
        const field = document.getElementById(fieldId);
        if (field) {
            field.classList.add('ring-2', 'ring-green-500', 'bg-green-50');
            setTimeout(() => {
                field.classList.remove('ring-2', 'ring-green-500', 'bg-green-50');
            }, 2000);
        }
    }
    
    function checkVisitorData(sourceField) {
        const email = document.getElementById('employee-email').value.trim();
        const phone = document.getElementById('employee-phone_number').value.trim();
        
        // Only check if email or phone is provided and has changed
        if ((!email && !phone) || (email === lastCheckedEmail && phone === lastCheckedPhone)) {
            return;
        }
        
        // Clear previous timeout
        if (visitorCheckTimeout) {
            clearTimeout(visitorCheckTimeout);
        }
        
        // Debounce AJAX call
        visitorCheckTimeout = setTimeout(() => {
            const params = new URLSearchParams();
            if (email) params.append('email', email);
            if (phone) params.append('phone', phone);
            
            fetch('{% url "backend:get_visitor_by_contact" %}?' + params.toString())
            .then(response => response.json())
            .then(data => {
                if (data.found) {
                    // Auto-fill form fields only if they are empty
                    const firstNameField = document.getElementById('employee-first_name');
                    const lastNameField = document.getElementById('employee-last_name');
                    const emailField = document.getElementById('employee-email');
                    const phoneField = document.getElementById('employee-phone_number');
                    
                    let fieldsUpdated = [];
                    
                    if (!firstNameField.value && data.data.first_name) {
                        firstNameField.value = data.data.first_name;
                        highlightField('employee-first_name');
                        fieldsUpdated.push('First Name');
                    }
                    
                    if (!lastNameField.value && data.data.last_name) {
                        lastNameField.value = data.data.last_name;
                        highlightField('employee-last_name');
                        fieldsUpdated.push('Last Name');
                    }
                    
                    if (!emailField.value && data.data.email && sourceField !== 'email') {
                        emailField.value = data.data.email;
                        highlightField('employee-email');
                        fieldsUpdated.push('Email');
                    }
                    
                    if (!phoneField.value && data.data.phone_number && sourceField !== 'phone') {
                        phoneField.value = data.data.phone_number;
                        highlightField('employee-phone_number');
                        fieldsUpdated.push('Phone');
                    }
                    
                    // Show notification if any fields were updated
                    if (fieldsUpdated.length > 0) {
                        showVisitorNotification(
                            `Visitor found! Auto-filled: ${fieldsUpdated.join(', ')}`,
                            'success'
                        );
                    }
                    
                    // Update last checked values
                    lastCheckedEmail = email;
                    lastCheckedPhone = phone;
                }
            })
            .catch(error => {
                console.error('Error checking visitor data:', error);
            });
        }, 600); // Wait 600ms after user stops typing
    }
    
    // Add event listeners for email and phone fields
    document.addEventListener('DOMContentLoaded', function() {
        const emailField = document.getElementById('employee-email');
        const phoneField = document.getElementById('employee-phone_number');
        
        if (emailField) {
            // Check on input (while typing) with debounce
            emailField.addEventListener('input', function() {
                checkVisitorData('email');
            });
            // Also check on blur
            emailField.addEventListener('blur', function() {
                checkVisitorData('email');
            });
        }
        
        if (phoneField) {
            // Check on input (while typing) with debounce
            phoneField.addEventListener('input', function() {
                checkVisitorData('phone');
            });
            // Also check on blur
            phoneField.addEventListener('blur', function() {
                checkVisitorData('phone');
            });
        }
    });

    // ===== PASSPORT FORM MANAGEMENT =====
    let passportFormCount = 1;

    function addPassportForm(event) {
        event.stopPropagation();
        
        const container = document.getElementById('passport-forms-container');
        const newIndex = passportFormCount;
        
        const formHTML = `
            <div class="passport-form-item border border-[var(--border-color)] rounded-lg p-4 mb-4" data-index="${newIndex}">
                <div class="flex justify-between items-center mb-4">
                    <h4 class="text-sm font-semibold text-[var(--text-color)]">Passport #${newIndex + 1}</h4>
                    <button type="button" onclick="removePassportForm(this)" class="text-red-500 hover:text-red-700 remove-passport-btn">
                        <i class="fas fa-trash"></i> Remove
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    <!-- Passport No -->
                    <div>
                        <label class="block text-sm font-medium text-[var(--text-color)] mb-1">Passport No</label>
                        <input type="text" name="passport-${newIndex}-passport_no" value="" placeholder="Enter Passport No" class="w-full h-11 px-3 text-sm bg-white border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent outline-none">
                    </div>

                    <!-- Passport Expiry Date -->
                    <div>
                        <label class="block text-sm font-medium text-[var(--text-color)] mb-1">Passport Expiry Date</label>
                        <input type="date" name="passport-${newIndex}-passport_expiry_date" value="" class="flatpickr-date w-full h-11 px-3 text-sm bg-white border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent outline-none">
                    </div>

                    <!-- Passport Renewed -->
                    <div>
                        <label class="block text-sm font-medium text-[var(--text-color)] mb-1">Passport Renewed</label>
                        <div class="flex items-center h-11">
                            <input type="checkbox" name="passport-${newIndex}-passport_renewed" class="w-5 h-5 text-[var(--primary-color)] border-[var(--border-color)] rounded focus:ring-[var(--primary-color)]">
                            <span class="ml-2 text-sm text-[var(--text-color)]">Yes</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        container.insertAdjacentHTML('beforeend', formHTML);
        passportFormCount++;
        
        // Update remove button visibility
        updatePassportRemoveButtons();
    }

    function removePassportForm(button) {
        const formItem = button.closest('.passport-form-item');
        formItem.remove();
        
        // Update numbering and reindex
        reindexPassportForms();
        
        // Update remove button visibility
        updatePassportRemoveButtons();
    }

    function reindexPassportForms() {
        const formItems = document.querySelectorAll('.passport-form-item');
        formItems.forEach((item, index) => {
            // Update title
            const title = item.querySelector('h4');
            title.textContent = `Passport #${index + 1}`;
            
            // Update data-index
            item.setAttribute('data-index', index);
            
            // Update all input names
            const inputs = item.querySelectorAll('input');
            inputs.forEach(input => {
                const name = input.getAttribute('name');
                if (name && name.startsWith('passport-')) {
                    const newName = name.replace(/passport-\d+-/, `passport-${index}-`);
                    input.setAttribute('name', newName);
                }
            });
        });
        
        // Update passportFormCount
        passportFormCount = formItems.length;
    }

    function updatePassportRemoveButtons() {
        const formItems = document.querySelectorAll('.passport-form-item');
        formItems.forEach((item) => {
            const removeBtn = item.querySelector('.remove-passport-btn');
            if (removeBtn) {
                if (formItems.length > 1) {
                    removeBtn.style.display = 'inline-flex';
                } else {
                    removeBtn.style.display = 'none';
                }
            }
        });
    }

    // ===== DRIVING LICENSE FORM MANAGEMENT =====
    let licenseFormCount = 1;

    function addDrivingLicenseForm(event) {
        event.stopPropagation();
        
        const container = document.getElementById('license-forms-container');
        const newIndex = licenseFormCount;
        
        const formHTML = `
            <div class="license-form-item border border-[var(--border-color)] rounded-lg p-4 mb-4" data-index="${newIndex}">
                <div class="flex justify-between items-center mb-4">
                    <h4 class="text-sm font-semibold text-[var(--text-color)]">License #${newIndex + 1}</h4>
                    <button type="button" onclick="removeDrivingLicenseForm(this)" class="text-red-500 hover:text-red-700 remove-license-btn">
                        <i class="fas fa-trash"></i> Remove
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    <!-- License No -->
                    <div>
                        <label class="block text-sm font-medium text-[var(--text-color)] mb-1">License No</label>
                        <input type="text" name="driving_license-${newIndex}-license_no" value="" placeholder="Enter License No" class="w-full h-11 px-3 text-sm bg-white border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent outline-none">
                    </div>

                    <!-- License Expiry Date -->
                    <div>
                        <label class="block text-sm font-medium text-[var(--text-color)] mb-1">License Expiry Date</label>
                        <input type="date" name="driving_license-${newIndex}-license_expiry_date" value="" class="flatpickr-date w-full h-11 px-3 text-sm bg-white border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent outline-none">
                    </div>

                    <!-- License Renewed -->
                    <div>
                        <label class="block text-sm font-medium text-[var(--text-color)] mb-1">License Renewed</label>
                        <div class="flex items-center h-11">
                            <input type="checkbox" name="driving_license-${newIndex}-license_renewed" class="w-5 h-5 text-[var(--primary-color)] border-[var(--border-color)] rounded focus:ring-[var(--primary-color)]">
                            <span class="ml-2 text-sm text-[var(--text-color)]">Yes</span>
                        </div>
                    </div>

                    <!-- License Renew Status -->
                    <div>
                        <label class="block text-sm font-medium text-[var(--text-color)] mb-1">License Renew Status</label>
                        <select name="driving_license-${newIndex}-license_renew_status" class="w-full h-11 px-3 pr-10 text-sm bg-white border border-[var(--border-color)] rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent outline-none">
                            <option value="">Select Status</option>
                            <option value="YES">Renewed</option>
                            <option value="NO">Not Renewed</option>
                        </select>
                    </div>
                </div>
            </div>
        `;
        
        container.insertAdjacentHTML('beforeend', formHTML);
        licenseFormCount++;
        
        // Update remove button visibility
        updateLicenseRemoveButtons();
    }

    function removeDrivingLicenseForm(button) {
        const formItem = button.closest('.license-form-item');
        formItem.remove();
        
        // Update numbering and reindex
        reindexLicenseForms();
        
        // Update remove button visibility
        updateLicenseRemoveButtons();
    }

    function reindexLicenseForms() {
        const formItems = document.querySelectorAll('.license-form-item');
        formItems.forEach((item, index) => {
            // Update title
            const title = item.querySelector('h4');
            title.textContent = `License #${index + 1}`;
            
            // Update data-index
            item.setAttribute('data-index', index);
            
            // Update all input/select names
            const inputs = item.querySelectorAll('input, select');
            inputs.forEach(input => {
                const name = input.getAttribute('name');
                if (name && name.startsWith('driving_license-')) {
                    const newName = name.replace(/driving_license-\d+-/, `driving_license-${index}-`);
                    input.setAttribute('name', newName);
                }
            });
        });
        
        // Update licenseFormCount
        licenseFormCount = formItems.length;
    }

    function updateLicenseRemoveButtons() {
        const formItems = document.querySelectorAll('.license-form-item');
        formItems.forEach((item) => {
            const removeBtn = item.querySelector('.remove-license-btn');
            if (removeBtn) {
                if (formItems.length > 1) {
                    removeBtn.style.display = 'inline-flex';
                } else {
                    removeBtn.style.display = 'none';
                }
            }
        });
    }
    </script>
{% endblock %}
